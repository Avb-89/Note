
# Linux_rpm_1c_обновление_платформы_Update_Platform

## Установка и обновление сервера 1С:Предприятие 8.3 на CentOS 7

  Установка сервера 1С:Предприятие 8.3
  Скопируем с диска ИТС или скачаем с сайта обновлений 1С https://users.v8.1c.ru 1С:Предприятия (64-bit) для RPM-based Linux-систем.
  Распакуем содержимое архива в заранее созданную папку /distrib

### Устанавливаем пакеты сервера 1с:

  ```
  # cd /ditrib/<папка с 1с> yum install *.rpm
  ```
  Проверим есть ли служба
  
  ```
  systemctl status srv1cv83
  cat /etc/rc.d/init.d/srv1cv83
  ```
  Если нет то делаем линк на службу
  ```
  cat /opt/1cv8/x86_64/8.3.18.1959/srv1cv83
  ln -s /opt/1cv8/x86_64/8.3.18.1959/srv1cv83 /etc/rc.d/init.d/srv1cv83
  ```

  Для того чтобы сервер 1С:Предприятие мог запускаться в автозагрузке необходимо в начале файла :

  ```
  vi /etc/rc.d/init.d/srv1cv83
  ```

  если добавить строку:
  ```
  #!/bin/sh
  ```

Запускаем сервер 1С:

  ```
  #chkconfig srv1cv83 on systemctl start srv1cv83
  ```
  Перезагружаем сервер:
  ```
  #reboot
  ```

После запуска проверяем что все запустилось:
  ```
  systemctl status srv1cv83
  ```

### Лицензирование

  Если лицензия программная  — то здесь все просто: Конфигуратор-Сервис-Лицензирование. 
  Программную лицензию (любую) рекомендуется получать «На этот компьютер» и «Всем пользователям данного компьютера».

  Если у нас HASP ключ для лицензирования, то сначала нужно его пробросить в виртуальную машину:

  Перезагружаем ВМ:
  ```
  #reboot
  ```

Далее устанавливаем службу haspd:

  ```
  yum -y install glibc.i686 wget http://download.etersoft.ru/pub/Etersoft/HASP/stable/CentOS/7/haspd-7.40-eter10centos.x86_64.rpm wget http://download.etersoft.ru/pub/Etersoft/HASP/stable/CentOS/7/haspd-modules-7.40-eter10centos.x86_64.rpm yum localinstall haspd-7.40-eter10centos.x86_64.rpm yum localinstall haspd-modules-7.40-eter10centos.x86_64.rpm
  ```
Правим настройки hasplm:

```
vi /etc/init.d/haspd status
```
Добавим в него:

```
NHS_IP_LIMIT = 127.0.0.1, 192.168.1.0/24
```

Именно в этой строчке перечисляем сети и хосты, которые смогут видеть HASP-ключ.



Перезагрузим сервер:

```
reboot
```

Проверим работу демона haspd:

```
/etc/init.d/haspd status
```


Проверяем слушается ли порт:

```
netstat -lunp | grep hasplm
```


При необходимости нужно указать на клиентских компьютерах в файле ***nethasp.ini*** адрес нашего сервера.


### Настройка сервера 1С:Предприятие в консоли администрирования


Создадим подключение к серверу 1С. Для этого укажем имя сервера (прописанное ранее в hosts) и порт 1540 (используется по умолчанию):


Далее создадим кластер. Для этого укажем произвольное имя кластера, имя сервера 1С и порт 1541.


После настройки кластера создадим базу данных

Необходимо указать:

имя базы на кластере 1С;
имя сервера баз данных (прописанное в hosts);
тип СУБД (PostgeSQL);
имя базы данных на сервере СУБД;
пользователь сервера СУБД (в нашем случае postgres);
пароль указанного пользователя сервера СУБД.


После этого можно подключаться к серверу.

<=======================================================
#	Обновление платформы 1С:Предприятие 8.3
=======================================================>
Перед выполнением нужно сделать снэпшот и убедится в наличии свежего бэкапа баз данных, а лучше сделать его.

Для обновления платформы необходимо, как и при установке, получить свежий дистрибудив Cервера 1С:Предприятия (64-bit) для RPM-based 
Linux-систем, затем разместить содержимое архива в предварительно очищенной папке /home/public/1c и выполнить команды:

cd /home/public/1c rpm -U *.rpm

Для того чтобы сервер 1С после обновления смог загружаться откроем инит файл 1С:

mcedit /etc/rc.d/init.d/srv1cv83

добавим в начале строку

#!/bin/sh

сохраним изменения и перезапустим службу сервера:

systemctl restart srv1cv83

после появившегося предупреждения

Warning: Unit file of srv1cv83.service changed on disk, ‘systemctl —system daemon-reload’ recommended.

Делаем, что советуют

systemctl --system daemon-reload

И повторяем попытку:



systemctl start srv1cv83

Проверяем состояние сервера:

systemctl status srv1cv83
