# MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV

## === Подготовка ===

Перед установкой надо сброить настройки, это можно сделать с помощью специальной кнопки на корпусе, или если у вас есть к нему доступ

`[sitis@MikroTik] > system reset-configuration`

На данном этапе НЕ ПОДКЛЮЧАЕМ КАБЕЛЬ ОТ ПРОВАЙДЕРА В НАШ РОУТЕР!

Подключаемся к роутеру 

### === Конфигурация пользователей ===

    Создаем пользователя и отключаем админа

`[sitis@MikroTik] > user add name=test password=test group=full`

`[sitis@MikroTik] > user disable admin`

    Делается это дабы исключить подбор пароля к вашему роутеру, т.к. практически всем известно имя пользователя по умолчанию.

### === Отключение интерфпейсов ===

Для интересах безопасности на этапах настройки, правилом хорошего тона считается - отключить все интерфейсы кроме того с которого мы подключились.

`[sitis@MikroTik] > interface print`

|#    NAME    |    TYPE   |   ACTUAL-MTU | L2MTU | MAX-L2MTU | MAC-ADDRESS      |
|-|-|-|-|-|-|
|0 XS ether1  |    ether  |         1500 |  1598 |      9214 | DC:2C:6E:01:57:57|
|1 RS ether2  |    ether  |         1500 |  1598 |      9214 | DC:2C:6E:01:57:58|
|2  S ether3  |    ether  |         1500 |  1598 |      9214 | DC:2C:6E:01:57:59|
|3 RS ether4  |    ether  |         1500 |  1598 |      9214 | DC:2C:6E:01:57:5A|
|4 RS ether5  |    ether  |         1500 |  1598 |      9214 | DC:2C:6E:01:57:5B|
|5 RS WLAN2G  |    wlan   |         1500 |  1600 |      2290 | DC:2C:6E:01:57:5C|

`[sitis@MikroTik] > interface disable ether1,ether2,ether3,ether4,ether5`

    Я подключен через wlan поэтому эти интерфейсы я не выключаю


## === Настройка портов и моста (bridge) ===

     у MikroTik’а нет такого понятия как выделенный WAN-порт как на бытовых маршрутизаторах, тут любой порт может выполнять любую роль. Хоть четырёх провайдеров в него заводите.

`[sitis@MikroTik] > interface bridge add name=Bridge-WiFi`

Далее идём в меню Bridge и добавляем два моста – bridge1-LAN и bridge2-WAN


Далее открываем там же вкладку Ports и добавляем там порты в наши мосты )) Порты ether1-ether4 и wlan1-wlan2 в бридж bridge1-LAN, порт ether5 соответственно в bridge2-WAN


Затем открываем меню Interfaces и на вкладке Interface List добавляем список ls-LAN-all нажав на кнопку Lists. Затем в данный список добавляем bridge1-LAN


На этом настройка портов и мостов закончена, перейдем к настройке локальной сети ))

## ============================

## ===Настройка локальной сети====

Перейдём в меню IP – Addresses и добавим новый адрес (в моём случае это 192.168.253.1, в вашем случае это может быть другой) присвоив его интерфейсу bridge1-LAN. Это и будет адрес нашего маршрутизатора. Адрес нужно добавлять с сетевой маской, так как на скриншоте. В принципе маску можно писать и полной – 192.168.253.1/255.255.255.0


Далее нам нужно настроить DHCP-сервер, который будет назначать IP-адреса сетевым устройствам в нашей локальной сети. Для этого перейдём в меню IP – DHCP Server и воспользуемся там мастером настроек нажав кнопку DHCP Setup. В принципе для типовой конфигурации можно со всем согласиться как есть привязав сервер к интерфейсу bridge1-LAN, единственно я добавил гугловские адреса DNS-серверов. Здесь может быть несколько вариантов – взять DNS-сервера от провайдера, добавить свои, добавить гугловские, настроить DNS-сервер на нашем маршрутизаторе и раздавать его. Последнему варианту будет посвящена отдельная статья, а пока оставим так – пусть будет гугл.


И напоследок переименуем наш DHCP-сервер в dhcp1-LAN, пригодится в будущем.



Начнём с настройки DHCP-клиента, для этого перейдем в меню IP – DHCP Client. Откроем вкладку DHCP Client Options и добавим там новый параметр со следующими значениями:

Name: parameter_request_list
Code: 55
Value: 0x010306212A79F9

Затем на вкладке DHCP Client добавляем нового клиента привязав его к интерфейсу bridge2-WAN.

Add Default Route выбираем special_classless, что позволяет получить classless маршрут, так и маршрут по умолчанию в стиле MS.

На вкладке Advanced добавляем DHCP Options: clientid, hostname и наш parameter_request_list. По поводу последнего параметра – не знаю точно передаёт ли билайн до сих пор что нибудь, но на всякий случай пусть будет, отключить никогда не поздно. Default Route Distance ставим 10.

/ip dhcp-client
add add-default-route=special-classless default-route-distance=10 dhcp-options=\
    clientid,hostname disabled=no interface=bridge2-WAN

    
Теперь настроим непосредственно L2TP подключение.

Перейдём в меню PPP и добавим L2TP Client. Назовём его l2tp-out1-beeline, Max MTU установим 1460, Max MRU 1500. Затем на вкладке Dial Out заполним поля Connect To: tp.internet.beeline.ru, User: ваш логин выданный провайдером, Password: соответственно ваш пароль, поставим галочку Add Default Route, Default Route Distance: 5, снимем галочки с mschap1 и pap

Primary DNS		195.239.225.93
Secondary DNS		195.239.225.94
Primary NTP		195.14.50.21
Secondary NTP		85.21.78.23

gateway 10.151.112.1

Добавить маршрут 195.239.225.93 через 10.151.112.1

Настройка firewall

Выбираем меню Interfaces и переходим на вкладку Interface List, добавляем новый список ls-WAN-all. Затем в этот список добавляем интерфейсы bridge2-WAN и l2tp-out1-beeline

Меню IP – Firewall на вкладке Address Lists добавляем список под названием LocalNet с нашими адресами – 192.168.253.0/24

Настройка firewall - добавляем список локальных адресов
Настройка firewall – добавляем список локальных адресов
Добавляем привила firewall. Что бы не пихать сюда кучу картинок напишу все правила скриптом, кто не знает, то просто вводите данные команды в окне терминала (меню New Terminal). Данные правила самые базовые, но на первых порах их должно быть достаточно.

/ip firewall filter
add action=accept chain=input connection-state=established,related
add action=accept chain=forward connection-state=established,related
add action=drop chain=input in-interface-list=ls-WAN-all
add action=drop chain=forward connection-state=invalid
add action=drop chain=forward connection-nat-state=!dstnat connection-state=new in-interface-list=ls-WAN-all
В результате должно выглядеть так как на скрине ниже, за исключением правил для IPTV, их добавим чуть попозже ))

Список правил firewall
Список правил firewall
На этом этапе можно включить отключенный интерфейс ether5 и попробовать что нибудь попинговать из терминала на MikroTik’е

ping from MikroTik terminal
ping from MikroTik terminal
Как видим интернет на маршрутизаторе уже есть и работает, но если попытаться сделать тоже самое с компьютера из локальной сети то ничего не получится, для этого добавим правила NAT

/ip firewall nat
add action=masquerade chain=srcnat out-interface-list=ls-WAN-all src-address=192.168.253.0/24
После этого у нас появился интернет и в нашей локальной сети.

25. ping from LAN
ping from LAN
Если интернет работает, но некоторые сайты почему то не открываются (не по причине блокировки Роскомнадзором) то можно попробовать добавить правило в Mangle

/ip firewall mangle
add action=change-mss chain=forward new-mss=1360 protocol=tcp tcp-flags=syn tcp-mss=1453-65535
Настройка IPTV

IPTV от билайна можно настроить двумя способами. Если вам удобнее протянуть кабель от приставки непосредственно к вашему MikroTik’у, то проще всего добавить ещё один порт в bridge2-WAN, предварительно удалив его из brifge1-LAN и подключить приставку в этот порт, например так:

Меняем ether4 с bridge1-LAN на bridge2-WAN
Меняем ether4 с bridge1-LAN на bridge2-WAN
Всё, больше ничего делать не нужно. Именно поэтому я для WAN сделал отдельный мост, а не настраивал как внешний интерфейс непосредственно порт ether5.

Если же вам удобнее IPTV-приставку подключить в коммутатор (switch), то продолжим настройку.

С официального сайта MikroTik из раздела Software нужно будет скачать Extra packages для своей версии прошивки. В моём случае это файл all_packages-arm-6.45.1.zip, т.к. я для написания данного материала пользуюсь MikroTik hAP ac² (RBD52G-5HacD2HnD).

Из полученного архива нам нужен файл multicast-6.45.1-arm.npk (в вашем случае может быть другой, в зависимости от архитектуры процессора и версии прошивки).

Для установки данного пакета в наш MikroTik нужно в WinBox открыть меню Files и в открывшееся окно просто перетащить нужный нам файл. Вместо того что бы перетаскивать, можно воспользоваться кнопкой Upload или просто сделать Copy-Paste. У меня почему то не получилось сделать это из WinBox и я воспользовался доступом через web-интерфейс, который в принципе почти полностью повторяет функционал WinBox, за исключением естественно возможности подключения по MAC-адресам. Так же для загрузки можно воспользоваться доступом по FTP или SFTP.

MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
WinBox – logon
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
WinBox – WebFig
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
WinBox – Files
Теперь просто перезагрузим роутер – меню Sytem – Reboot и после перезагрузки данный дополнительный пакет будет установлен в систему, убедиться в этом можно перейдя по меню System – Packages

MikriTik Packages
MikriTik Packages
После установки необходимого нам пакета multicast приступим непосредственно к настройкам.

В меню Bridge открываем bridge1-LAN и включаем там IGMP Snooping

Включаем IGMP Snooping в bridge1-LAN
Включаем IGMP Snooping в bridge1-LAN
Тоже из консоли:

/interface bridge
set bridge1-LAN igmp-snooping=yes
Routing – IGMP Proxy – нажимаем кнопочку Setup и устанавливаем параметры Query Interval: 30 секунд и Query Response Interval: 20 секунд, Quick Leave оставляем выключенным.

Настройка параметров IGMP Proxy
Настройка параметров IGMP Proxy
Из консоли:

/routing igmp-proxy  
set query-interval=30s query-response-interval=20s quick-leave=no
Теперь в IGMP Proxy добавляем интерфейс bridge2-WAN с параметрами Alternative Subnets: 0.0.0.0/0, включаем Upstream и интерфейс bridge1-LAN – никаких параметров не меняем.

MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
Из консоли:

/routing igmp-proxy interface
add alternative-subnets=0.0.0.0/0 interface=bridge2-WAN upstream=yes
add interface=bridge1-LAN
Осталось добавить пару правил в firewall:

/ip firewall filter﻿  
add chain=input protocol=igmp﻿﻿﻿ action=accept﻿﻿﻿  ﻿
add chain=forward dst-address=232.0.0.0/5 protocol=udp action=accept﻿﻿﻿
Нужно проследить что бы данные правила были выше первого дропа в цепочке, т.е. правило chain=input protocol=igmp﻿﻿﻿ action=accept﻿﻿﻿ ﻿должно быть выше первого дропа в цепочке input, а правило chain=forward dst-address=232.0.0.0/5 protocol=udp action=accept должно быть выше первого дропа в цепочке forward.

Порядок следования правил в WinBox можно поменять просто перетащив нужное правило на своё место – вверх или вниз. В нашем случае результат будет таким:

Правила firewall для IPTV
Правила firewall для IPTV
Не забывайте к каждому правилу добавлять комментарии, что бы потом не запутаться какое правило за что отвечает.

С настройками IPTV на MikroTik на этом закончим – телевизор показывает ))

Последние необходимые изменения

В принципе у нас уже всё работает, но необходимо внести ещё парочку мелких изменений в настройки нашего MikroTik.

Отключим все неиспользуемые нами сервисы. Для этого перейдём в меню IP – Services и отключим всё, что мы не используем, а для тех что используем ограничим доступ только из локальной сети:

MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
/ip service
set telnet disabled=yes
set ftp disabled=yes
set www address=192.168.253.0/24
set ssh address=192.168.253.0/24
set api disabled=yes
set winbox address=192.168.253.0/24
set api-ssl disabled=yes
И ограничим обнаружение нашего маршрутизатора только в локальной сети:

/ip neighbor discovery-settings
set discover-interface-list=ls-LAN-all
Настраиваем Neighbor Discovery
Настраиваем Neighbor Discovery
Ну и включим поддержку UPnP для устройств и программ поддерживающих данную технологию, например для торрентов, что бы он смог принимать входящие соединения. Если поддержка UPnP не нужна, то лучше данную опцию не включать, т.к. она может нести в себе определённую угрозу вашей сети.

/ip upnp
set allow-disable-external-interface=yes enabled=yes
/ip upnp interfaces
add interface=bridge1-LAN type=internal
add interface=bridge2-WAN type=external
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
MikroTik: Базовая настройка и настройка подключения L2TP от Билайн + IPTV
На этом часть про базовые настройки маршрутизатора на основе RouterOS можно считать завершённой.

За бортом остались настройки Wi-Fi, настройки DNS и много чего ещё, но это уже тема последующих статей.

Все приведённые примеры использовались и работают на маршрутизаторе MikroTik hAP ac² (RBD52G-5HacD2HnD-TC) с версией RouterOS 6.45.1.

Отдельно хочу сказать огромное человеческое спасибо своему хорошему другу Владу Глазкову, без его подсказок и советов данной статьи просто не было бы.

С благодарностью приму конструктивную критику и замечания в комментариях.

Обновление от 20.07.2019: В настройках DHCP клиента в parameter_request_list добавил получение Classless Static Route Option, правда в моём регионе (Красноярск) билайн кажется “забил” на это (

Обновление от 17.10.2019: В настройках DHCP клиента удалён параметр parameter_request_list и Add Default Route изменён с yes (по умолчанию) на special-classless, что позволяет получать как classless маршруты так и маршрут по умолчанию в стиле MS.

Освоить MikroTik Вы можете с помощью онлайн-куса «Настройка оборудования MikroTik». Курс содержит все темы, которые изучаются на официальном курсе MTCNA. Автор курса – официальный тренер MikroTik. Подходит и тем, кто уже давно работает с микротиками, и тем, кто еще их не держал в руках. В курс входит 162 видеоурока, 45 лабораторных работ, вопросы для самопроверки и конспект.

